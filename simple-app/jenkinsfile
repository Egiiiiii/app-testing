pipeline {
    agent any

    tools {
        nodejs "node18"
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Egiiiiii/simple-app.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('simple-app') {
                    sh 'npm install'
                }
            }
        }

        stage('Lint Check') {
            steps {
                dir('simple-app') {
                    // cek error syntax
                    sh 'node -c index.js || true'
                }
            }
        }

        stage('Run Tests') {
            steps {
                dir('simple-app') {
                    // kalau tidak ada test, ini memastikan app bisa start
                    sh 'node index.js & sleep 3; pkill node'
                }
            }
        }

        stage('Build') {
            steps {
                echo 'Build proses (opsional)...'
            }
        }

        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                echo 'Deploying to server...'

                // contoh deploy via ssh
                sh """
                ssh -o StrictHostKeyChecking=no root@SERVER_IP '
                    cd /var/www/myapp &&
                    git pull &&
                    pm2 restart all
                '
                """
            }
        }
    }

    post {
        failure {
            echo "❌ Build gagal — tidak di-deploy."
        }
        success {
            echo "✅ Build sukses — aplikasi telah di-deploy."
        }
    }
}
